#Loading the packages
```{r load_packages}
library(tidyverse)
library(readr)
library(readxl)
library(reactable)
library(scales)
```

```{r functions}
densityPlot = function(x_var, plot_name, x_name){
  x <- na.omit(x)
  hist(x_var, col = "red", border = "black", prob = TRUE, main = plot_name, xlab = x_name)
  lines(density(x_var), col = "blue", lwd = 2)
}

bach_point = function(x_var){
  ggplot(full_county_table, aes(x_var, Percent_Bachelors))+
  geom_point()
}

bach_smooth = function(x_var){
  ggplot(full_county_table, aes(x_var, Percent_Bachelors))+
  geom_smooth()
}

bach_boxplot = function(x_var){
  ggplot(full_county_table, aes(x_var, Percent_Bachelors))+
  geom_boxplot()
}
  

```

```{r importing_csv}
Enrollment_dataset <- read_csv("dataset/public-vs-private-enrollment-county-2019.csv") 
```

```{r importing_xl}
Unemployment_dataset <- read_excel("dataset/Unemployment.xlsx", range = "A5:CN3201")
Education_dataset <- read_excel("dataset/Education.xlsx", range = "A5:AU3209")
Population_dataset <- read_excel("dataset/PopulationEstimates.xlsx", range = "A2:H3203")
Poverty_dataset <- read_excel("dataset/PovertyEstimates.xls", range = "A5:AB3198")
```

#Tidying the tables

```{r tidy_tables}
income_table <- Unemployment_dataset %>%
  select("FIPS_Code","Area_name","Median_Household_Income_2019")

edu_table <- Education_dataset %>%
  select(c(1),c(3),c(44:47))%>%
  rename("FIPS_Code" = c(1), "Area_name" = c(2), "Percent_No_Diploma" = c(3), "Percent_Diploma" = c(4), "Percent_Associates" = c(5),"Percent_Bachelors" = c(6))

popn_table <- Population_dataset%>%
  select(-c(2),-c(6:7))%>%
  rename("FIPS_Code" = c(1),"Area_name" = c(2),"Rural_urban_code" = c(3),"Start_popn" = c(4), "End_popn" = c(5))%>%
  mutate(avg_decade_growth_rate = ((1+((End_popn-Start_popn)/Start_popn))^(1/3)-1))

pov_table <- Poverty_dataset%>%
  select(c(1),c(3),c(11))%>%
  rename("FIPS_Code" = c(1),"Percent_Poverty" = c(3))

```


Merged Tables:

```{r merged_tables}
inc_edu_state <- merge(x = income_table, y = edu_table, by = "FIPS_Code")%>%
  select(-c(4))%>%
  filter(endsWith(FIPS_Code,"000"))

inc_edu_county <- merge(x = income_table, y = edu_table, by = "FIPS_Code")%>%
  select(-c(4))%>%
  filter(!endsWith(FIPS_Code,"000"))
```

Full Tables:

```{r join_county_tables}
full_county_table <- Reduce(function(...) merge(..., all = TRUE, by = "FIPS_Code"),
  list(income_table, edu_table, popn_table, pov_table))%>%
  select(-c(4),-c(9),-c(14))%>%
  filter(!endsWith(FIPS_Code,"000"))%>%
  drop_na()

full_state_table <- Reduce(function(...) merge(..., all = TRUE, by = "FIPS_Code"),
  list(income_table, edu_table, popn_table, pov_table))%>%
  select(-c(4),-c(9),-c(14))%>%
  filter(endsWith(FIPS_Code,"000"))%>%
  select(-c(8))

```
County Table Grouped By Urban Classification

```{r}
grouped_by_urban_class <- full_county_table %>%
group_by(Rural_urban_code)%>%
  summarise_at(vars(Percent_Bachelors),funs(mean(Percent_Bachelors)))
```

Graphs:

```{r graphs}

bach_point(full_county_table$Median_Household_Income_2019)
bach_smooth(full_county_table$Median_Household_Income_2019)

bach_point(full_county_table$avg_decade_growth_rate)
bach_smooth(full_county_table$avg_decade_growth_rate)

bach_point(full_county_table$Percent_Poverty)
bach_smooth(full_county_table$Percent_Poverty)

bach_boxplot(full_county_table$Rural_urban_code)

ggplot(grouped_by_urban_class, aes(Rural_urban_code,Percent_Bachelors,fill = Rural_urban_code))+
  geom_col()+
  theme(legend.position = "none")
```

```{r Statewise Cleaning}


library (usmap)
St_Pop <- inc_edu_state[order(inc_edu_state$Area_name),]
St_Pop <- St_Pop[!(St_Pop$Area_name == "United States"),]
St_Pop$fips <- statepop$fips
St_Pop$abbr <- statepop$abbr

St_Pop <- St_Pop %>% 
  rename(Income = Median_Household_Income_2019) %>% 
  rename(Less_than_High_School = `Percent_No_Diploma`) %>% 
  rename ( High_School_Only = `Percent_Diploma`) %>% 
  rename(College_or_Associate = `Percent_Associates`) %>% 
  rename(Bachelors = `Percent_Bachelors`)

```

```{r Countywise Cleaning}
#anti_join(countypop, Ct_Pop, by = "fips")
Ct_Pop <- inc_edu_county[order(inc_edu_county$Area_name),]
Ct_Pop <- Ct_Pop[order(Ct_Pop$FIPS_Code),]
Ct_Pop <- na.omit(Ct_Pop)
temp1 <- countypop
temp2 <- temp1[!(temp1$fips == "15005"),]
Ct_Pop$fips <- temp2$fips
Ct_Pop$abbr <- temp2$abbr
Ct_Pop <- Ct_Pop %>% 
  rename(Income = Median_Household_Income_2019) %>% 
  rename(Less_than_High_School = `Percent_No_Diploma`) %>% 
  rename ( High_School_Only = `Percent_Diploma`) %>% 
  rename(College_or_Associate = `Percent_Associates`) %>% 
  rename(Bachelors = `Percent_Bachelors`)

```


